name: todoapp_project
trigger: none
pool: todoapp_project

parameters:
  - name: environment
    displayName: environment selection
    type: string
    default: prod
    values:
      - prod
      - dev

variables:
  work_dir: '$(System.DefaultWorkingDirectory)/environment'
  S_conn: 'todoapp_project'

stages:

# -------------------------
# Stage 1: Static analysis
# -------------------------
- stage: StaticAnalysis1
  displayName: "Static analysis tflint"
  jobs:
  - job: StaticAnalysisJob
    displayName: "Run IaC lint & security scans"
    steps:
      - checkout: self

      - task: PowerShell@2
        displayName: "TFLint Scan"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            tflint --recursive

- stage: StaticAnalysis2
  displayName: "Static analysis tfsec"
  jobs:
   - job: StaticAnalysisJob
     displayName: "Run IaC tfsec & security scans"
     steps:
     - task: PowerShell@2
       displayName: "tfsec Scan"
       inputs:
        targetType: 'inline'
        script: |
          cd "$(work_dir)\${{ parameters.environment }}"
          tfsec .
          
- stage: StaticAnalysis3
  displayName: "Static analysis Checkov"
  jobs:
   - job: StaticAnalysisJob
     displayName: "Run Checkov"
     steps:
     - task: PowerShell@2        
       displayName: "Checkov Scan"
       inputs:
        targetType: 'inline'
        script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            checkov -d .
            if ($LASTEXITCODE -ne 0) { exit 0 }

- stage: StaticAnalysis4
  displayName: "Static analysis trivy"
  jobs:
   - job: StaticAnalysisJob
     displayName: "Run IaC trivy"
     steps:
      - task: PowerShell@2        
        displayName: "Trivy Scan"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            trivy fs . --skip-db-update --skip-java-db-update --offline-scan --security-checks vuln
            if ($LASTEXITCODE -ne 0) { exit 0 }

# -------------------------------
# Stage 2: Terraform Init + Plan
# -------------------------------
- stage: Plan
  displayName: "Terraform Init & Plan"
  dependsOn: StaticAnalysis4
  jobs:
  - job: PlanJob
    displayName: "Run Terraform Init & Plan"
    steps:

      - task: PowerShell@2
        displayName: "Terraform Init"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            terraform init

      - task: PowerShell@2
        displayName: "Terraform Plan"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            terraform plan -out tfplan.binary

      - task: PowerShell@2
        displayName: "Terraform Show (JSON)"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            terraform show -json tfplan.binary > plan.json

      - task: PublishBuildArtifacts@1
        displayName: "Upload Plan Files"
        inputs:
          PathtoPublish: '$(work_dir)\${{ parameters.environment }}'
          ArtifactName: 'terraform-plan'

# --------------------------------
# Stage 3: Infracost Cost Analysis
# --------------------------------
- stage: CostAnalysis
  displayName: "Infracost Cost Estimation"
  dependsOn: Plan
  jobs:
  - job: CostJob
    displayName: "Run Infracost"
    steps:

      - task: PowerShell@2
        displayName: "Infracost Breakdown"
        inputs:
          targetType: 'inline'
          script: |
            cd "$(work_dir)\${{ parameters.environment }}"
            infracost breakdown --path plan.json --format html --out-file infracost.html
            if ($LASTEXITCODE -ne 0) { exit 0 }

      - task: PublishBuildArtifacts@1
        displayName: "Upload Infracost Report"
        inputs:
          PathtoPublish: '$(work_dir)\${{ parameters.environment }}\infracost.html'
          ArtifactName: 'infracost-report'